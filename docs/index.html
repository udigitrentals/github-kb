<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KB Live Viewer + MD → JSON Uploader</title>
  <meta name="description" content="Drop Markdown, ingest losslessly, and generate registry.json, search.json, and cross_links.json (download as ZIP)." />
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <style>
    :root{
      --bg:#0b0b0b;--panel:#121212;--ink:#ececec;--muted:#a9a9a9;--accent:#E1BC56;--cta:#A90F0F;--ok:#1f9d55;--warn:#d39e00;--bad:#c0392b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    header{padding:20px 24px;background:linear-gradient(180deg,#706A6A 0%, #000 100%);border-bottom:1px solid #333}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    main{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns: 1.2fr .8fr}}
    .card{background:var(--panel);border:1px solid #2a2a2a;border-radius:14px;padding:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    input[type="text"],textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:var(--ink)}
    textarea{min-height:96px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;background:#1f1f1f;color:#fff;border:1px solid #333;cursor:pointer}
    .btn.primary{background:var(--cta);border-color:#600;}
    .btn.good{background:var(--ok)}
    .btn.warn{background:var(--warn);color:#222}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #333;background:#0f0f0f;color:#bbb;font-size:12px}
    .drop{border:2px dashed #3a3a3a;border-radius:14px;padding:18px;text-align:center;background:#0e0e0e}
    .drop.drag{border-color:var(--accent);background:#151007}
    .list{max-height:260px;overflow:auto;border:1px solid #222;border-radius:10px}
    .item{padding:10px 12px;border-bottom:1px solid #1a1a1a;display:flex;align-items:center;gap:8px}
    .item:last-child{border-bottom:none}
    .item b{font-weight:600}
    code,kbd{background:#0a0a0a;border:1px solid #333;color:#ddd;padding:2px 6px;border-radius:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ok{color:var(--ok)}.bad{color:var(--bad)}
    .muted{color:var(--muted)}
    footer{opacity:.8;text-align:center;padding:20px}
    .small{font-size:12px}
    details{border:1px dashed #333;border-radius:10px;padding:10px}
    summary{cursor:pointer}
  </style>
</head>
<body>
  <header>
    <h1>KB Live Viewer + Uploader · <span class="muted">MD → registry.json / search.json / cross_links.json</span></h1>
  </header>
  <main>
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill">Status: <span id="status" class="ok">Idle</span></span>
            <span class="pill">Files: <span id="fileCount">0</span></span>
            <span class="pill">Blocks: <span id="blockCount">0</span></span>
          </div>
          <div class="row">
            <button id="btnClear" class="btn" title="Clear files">Clear</button>
          </div>
        </div>
        <div id="drop" class="drop" tabindex="0">
          <p><b>Drop Markdown files here</b> or <label for="file" class="pill" style="cursor:pointer">browse…</label></p>
          <input id="file" type="file" accept=".md,.markdown,.txt" multiple hidden />
          <p class="small muted">Lossless ingestion: headings, code fences, inline links preserved. We auto‑segment into search blocks.</p>
        </div>
        <div class="row" style="margin-top:12px">
          <input id="collection" type="text" placeholder="collection (e.g., kb)" value="kb" />
          <input id="baseUrl" type="text" placeholder="base url for raw links (optional)" value="https://raw.githubusercontent.com/udigitrentals/github-kb/main/docs" />
        </div>
        <details style="margin-top:12px">
          <summary>Advanced: merge with existing JSONs</summary>
          <div class="row" style="margin-top:10px">
            <label>Upload existing <b>registry.json</b> (optional)</label>
            <input id="existingRegistry" type="file" accept="application/json" />
          </div>
          <div class="row">
            <label>Upload existing <b>search.json</b> (optional)</label>
            <input id="existingSearch" type="file" accept="application/json" />
          </div>
          <div class="row">
            <label>Upload existing <b>cross_links.json</b> (optional)</label>
            <input id="existingCross" type="file" accept="application/json" />
          </div>
          <div class="row" style="margin-top:10px">
            <label><input id="dedupe" type="checkbox" checked /> De‑duplicate by <code>id</code> and <code>slug</code></label>
          </div>
        </details>
      </section>

      <aside class="card">
        <b>Steps</b>
        <ol class="small">
          <li>Drop one or more <b>.md</b> files.</li>
          <li>Click <b>Generate JSONs</b>.</li>
          <li>Download the ZIP and upload <code>registry.json</code>, <code>search.json</code>, <code>cross_links.json</code> to your repo's <code>/docs/</code> folder.</li>
          <li>Redeploy on Vercel.</li>
        </ol>
        <div class="row" style="margin-top:10px">
          <button id="btnGenerate" class="btn primary" disabled>Generate JSONs</button>
          <a id="zipLink" class="btn good" download="kb_payload.zip" href="#" style="display:none">Download ZIP</a>
        </div>
        <p class="small muted" id="genMeta"></p>
        <hr style="border-color:#222" />
        <div class="list" id="fileList"></div>
      </aside>
    </div>

    <section class="card" style="margin-top:16px">
      <b>Preview</b>
      <p class="small muted">First 2 generated blocks will appear below for sanity‑check after generation.</p>
      <pre class="mono small" id="preview" style="white-space:pre-wrap"></pre>
    </section>

    <section class="card" style="margin-top:16px">
      <b>Notes</b>
      <ul class="small">
        <li><b>Segmentation</b>: starts a new block on ATX headings (<code>#</code> to <code>###</code>) or horizontal rules (<code>---</code>, <code>***</code>, <code>___</code>), while preserving code fences.</li>
        <li><b>IDs</b>: cryptographic (SHA‑256) over <code>file name + block index + title + content</code>.</li>
        <li><b>registry.json</b>: minimal metadata for each block (id, title, slug, file, block_index, word_count, headings, links, hash).</li>
        <li><b>search.json</b>: searchable items (id, title, excerpt, tokens). You can sharded‑split later if desired.</li>
        <li><b>cross_links.json</b>: graph edges discovered from inline Markdown links.</li>
      </ul>
    </section>

  </main>
  <footer class="small muted">Built for U‑Dig It KB · Client‑side only · No servers required.</footer>

<script>
(function(){
  const $$ = sel => document.querySelector(sel);
  const statusEl = $$('#status');
  const fileList = $$('#fileList');
  const drop = $$('#drop');
  const fileInput = $$('#file');
  const btnGenerate = $$('#btnGenerate');
  const btnClear = $$('#btnClear');
  const zipLink = $$('#zipLink');
  const preview = $$('#preview');
  const fileCountEl = $$('#fileCount');
  const blockCountEl = $$('#blockCount');
  const genMeta = $$('#genMeta');

  let files = []; // {name, text}

  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = cls || '';
  }

  btnClear.addEventListener('click', () => {
    files = [];
    fileList.innerHTML = '';
    fileCountEl.textContent = '0';
    blockCountEl.textContent = '0';
    btnGenerate.disabled = true;
    zipLink.style.display = 'none';
    preview.textContent = '';
    setStatus('Idle','ok');
  });

  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', e => { drop.classList.remove('drag'); });
  drop.addEventListener('drop', async e => {
    e.preventDefault(); drop.classList.remove('drag');
    await handleFiles(e.dataTransfer.files);
  });
  drop.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async e => { await handleFiles(e.target.files); });

  async function handleFiles(list){
    const arr = [...list].filter(f => /\.(md|markdown|txt)$/i.test(f.name));
    for (const f of arr){
      const text = await f.text();
      files.push({name:f.name, text});
      const size = new Intl.NumberFormat().format(f.size);
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<span class="pill">MD</span> <b>${escapeHtml(f.name)}</b> <span class="muted">${size} bytes</span>`;
      fileList.appendChild(el);
    }
    fileCountEl.textContent = String(files.length);
    btnGenerate.disabled = files.length === 0;
    setStatus('Ready','ok');
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function slugify(s){
    return s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-').replace(/-+/g,'-').slice(0,120);
  }

  function tokenize(s){
    return Array.from(new Set((s.toLowerCase().match(/[a-z0-9]{2,}/g) || []).slice(0,1200)));
  }

  function extractLinks(md){
    const links = [];
    const re = /\[([^\]]+)\]\(([^)\s]+)(?:\s+\"([^\"]*)\")?\)/g; // [text](url "title")
    let m; while((m = re.exec(md))){ links.push({text:m[1], href:m[2]}); }
    return links;
  }

  function splitBlocks(md){
    // Preserve code fences by temporarily marking them
    const fences = [];
    const fenced = md.replace(/```([\s\S]*?)```/g, (m, p1) => {
      const key = `__FENCE_${fences.length}__`;
      fences.push(m); return key;
    });
    const lines = fenced.split(/\r?\n/);
    const blocks = [];
    let cur = [];
    const hrRe = /^\s*(?:-{3,}|\*{3,}|_{3,})\s*$/;
    const hRe = /^#{1,3}\s+.+/;
    for (let i=0;i<lines.length;i++){
      const L = lines[i];
      if (i>0 && (hRe.test(L) || hrRe.test(L))){
        if (cur.length){ blocks.push(cur.join('\n')); cur = []; }
      }
      cur.push(L);
    }
    if (cur.length) blocks.push(cur.join('\n'));

    // Restore fences
    const restored = blocks.map(b => b.replace(/__FENCE_(\d+)__/g, (_,i)=>fences[+i]));
    return restored.map(b => b.trim()).filter(Boolean);
  }

  function extractTitle(block, fallback){
    const m = block.match(/^#{1,6}\s+(.+)/);
    if (m) return m[1].trim();
    // Try bold line
    const b = block.split(/\n/)[0].trim();
    return b.length>0? (b.length>120? b.slice(0,120)+'…' : b) : fallback;
  }

  function excerpt(s){
    const plain = s.replace(/```[\s\S]*?```/g,' ').replace(/\!\[[^\]]*\]\([^\)]*\)/g,' ').replace(/\[[^\]]*\]\([^\)]*\)/g,' ').replace(/[#>*_`~\-]/g,' ');
    return plain.replace(/\s+/g,' ').trim().slice(0,220);
  }

  async function generate(){
    setStatus('Generating…');
    zipLink.style.display = 'none';
    preview.textContent = '';

    const collection = $$('#collection').value.trim() || 'kb';
    const baseUrl = $$('#baseUrl').value.trim();

    // Load existing (optional)
    async function readJson(fileInput){
      const f = fileInput.files && fileInput.files[0];
      if (!f) return null; try{ return JSON.parse(await f.text()); }catch(e){ console.warn('Invalid JSON', e); return null; }
    }
    const existingRegistry = await readJson($$('#existingRegistry'));
    const existingSearch = await readJson($$('#existingSearch'));
    const existingCross = await readJson($$('#existingCross'));

    const registryItems = [];
    const searchItems = [];
    const edges = [];

    let totalBlocks = 0;

    for (const file of files){
      const blocks = splitBlocks(file.text);
      for (let i=0;i<blocks.length;i++){
        const block = blocks[i];
        const title = extractTitle(block, file.name.replace(/\.(md|markdown|txt)$/i,''));
        const id = await sha256Hex(file.name+'|'+i+'|'+title+'|'+block);
        const slug = slugify(title || (file.name+ '-' + i));
        const wc = (block.match(/\S+/g) || []).length;
        const headings = (block.match(/^#{1,6}\s+.+/gm) || []).map(s=>s.replace(/^#+\s+/,'').trim());
        const links = extractLinks(block);
        const now = new Date().toISOString();
        const hash = await sha256Hex(block);

        registryItems.push({
          id, title, slug, collection, file:file.name, block_index:i, word_count:wc,
          headings, links, hash, updated_at: now,
          raw_url: baseUrl? `${baseUrl}` : null
        });

        searchItems.push({ id, title, excerpt: excerpt(block), tokens: tokenize(block) });

        for (const l of links){
          edges.push({ source:id, target:l.href, label:l.text || null });
        }
      }
      totalBlocks += blocks.length;
    }

    // Merge with existing (optional)
    const doDedupe = $$('#dedupe').checked;
    function uniqueByIdSlug(arr){
      const seen = new Set();
      const out = [];
      for (const it of arr){
        const k = `${it.id}::${it.slug||''}`;
        if (doDedupe && seen.has(k)) continue;
        seen.add(k); out.push(it);
      }
      return out;
    }

    const registryDoc = {
      version: 1,
      generated_at: new Date().toISOString(),
      items: uniqueByIdSlug([...(existingRegistry?.items||existingRegistry||[]), ...registryItems])
    };

    const searchDoc = uniqueByIdSlug([...(existingSearch||[]), ...searchItems]);

    const crossDoc = {
      version: 1,
      generated_at: new Date().toISOString(),
      edges: uniqueByIdSlug([...(existingCross?.edges||existingCross||[]), ...edges])
    };

    // Preview
    const prev = [registryDoc.items[0], registryDoc.items[1]].filter(Boolean);
    preview.textContent = JSON.stringify(prev, null, 2);

    blockCountEl.textContent = String(totalBlocks);

    // ZIP
    const zip = new JSZip();
    zip.file('registry.json', JSON.stringify(registryDoc, null, 2));
    zip.file('search.json', JSON.stringify(searchDoc, null, 2));
    zip.file('cross_links.json', JSON.stringify(crossDoc, null, 2));

    const blob = await zip.generateAsync({type:'blob'});
    const href = URL.createObjectURL(blob);
    zipLink.href = href; zipLink.style.display = 'inline-block';
    genMeta.textContent = `Created ${registryDoc.items.length} registry items, ${searchDoc.length} search entries, ${crossDoc.edges.length} cross-links.`;
    setStatus('Ready to download','ok');
  }

  btnGenerate.addEventListener('click', generate);
})();
</script>
</body>
</html>