
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KB Live Viewer + Probe (Integrated)</title>
<meta name="description" content="Load/diagnose KB (registry/search/cross_links), tolerant schemas, base/rawBase switching, and downloads."/>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
<style>
:root{--bg:#0b0b0b;--panel:#121212;--ink:#ececec;--muted:#a9a9a9;--accent:#E1BC56;--cta:#C21C1C;--ok:#1f9d55;--warn:#d39e00;--err:#c0392b;--radius:12px;--border:#1e1e1e;--shadow:0 10px 20px rgba(0,0,0,.25);}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:#000;box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
h1{margin:0;font-size:18px;letter-spacing:.2px}
small.muted{color:var(--muted)}
.container{max-width:1200px;margin:20px auto;padding:0 16px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.btn{background:var(--cta);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.secondary{background:#232323}
.btn.ghost{background:transparent;border:1px solid #333}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.badge.ok{background:rgba(31,157,85,.2);color:var(--ok)}
.badge.err{background:rgba(192,57,43,.2);color:var(--err)}
input,textarea{background:#0f0f0f;color:var(--ink);border:1px solid #2f2f2f;border-radius:10px;padding:9px 10px}
code,pre{background:#0f0f0f;border:1px solid #2f2f2f;border-radius:10px;padding:10px;color:var(--accent)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #272727;text-align:left}
.grid{display:grid;grid-template-columns:repeat(3,minmax(240px,1fr));gap:12px}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:8px}
.hidden{display:none}
footer{opacity:.6;text-align:center;padding:24px}
</style>
</head>
<body>
<header>
  <div>
    <h1>KB Live Viewer <small class="muted">+ Integrated Probe</small></h1>
  </div>
  <div class="row">
    <button class="btn secondary" id="theme">Theme</button>
    <button class="btn ghost" id="reload">Reload</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <label>Local base&nbsp;<input id="base" placeholder="/docs" value="/docs"/></label>
      <label>Raw base&nbsp;<input id="rawBase" placeholder="https://raw.githubusercontent.com/ORG/REPO/main/docs"/></label>
      <button class="btn" id="apply">Apply</button>
      <button class="btn ghost" id="clearCache">Clear cache</button>
      <button class="btn ghost" id="probe">Run Probe</button>
      <button class="btn" id="downloadAll">Download all JSONs</button>
    </div>
    <div class="kv">
      <div>Resolved:</div>
      <div id="resolved">—</div>
      <div>Status:</div>
      <div id="status">Waiting…</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>registry.json <span id="regStatus" class="badge">—</span></h3>
      <div id="regCount">—</div>
      <pre id="regPreview" class="hidden"></pre>
      <button class="btn ghost" id="toggleReg">Toggle preview</button>
    </div>
    <div class="card">
      <h3>search.json <span id="sStatus" class="badge">—</span></h3>
      <div id="sCount">—</div>
      <pre id="sPreview" class="hidden"></pre>
      <button class="btn ghost" id="toggleS">Toggle preview</button>
    </div>
    <div class="card">
      <h3>cross_links.json <span id="xStatus" class="badge">—</span></h3>
      <div id="xCount">—</div>
      <pre id="xPreview" class="hidden"></pre>
      <button class="btn ghost" id="toggleX">Toggle preview</button>
    </div>
  </div>

  <div class="card">
    <h3>Diagnostic Log</h3>
    <pre id="log" style="max-height:320px;overflow:auto"></pre>
  </div>
</div>

<footer class="container">
  <small>Tip: you can pass <code>?base=/docs&rawBase=https://raw.githubusercontent.com/udigitrentals/github-kb/main/docs</code></small>
</footer>

<script>
// ---------- Theme toggle (light/dark minimal) ----------
document.getElementById('theme').onclick = () => {
  document.body.classList.toggle('light');
};

// ---------- Params & inputs ----------
const qs = new URLSearchParams(location.search);
const baseInput = document.getElementById('base');
const rawInput  = document.getElementById('rawBase');
baseInput.value = qs.get('base') || localStorage.getItem('kb.base') || baseInput.value;
rawInput.value  = qs.get('rawBase') || localStorage.getItem('kb.rawBase') || rawInput.value;
document.getElementById('apply').onclick = () => {
  localStorage.setItem('kb.base', baseInput.value);
  localStorage.setItem('kb.rawBase', rawInput.value);
  location.search = `?base=${encodeURIComponent(baseInput.value)}&rawBase=${encodeURIComponent(rawInput.value)}`;
};
document.getElementById('clearCache').onclick = () => { caches && caches.keys && caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); localStorage.clear(); alert('Cache cleared. Reloading.'); location.reload(); };
document.getElementById('reload').onclick = () => location.reload();

// ---------- Logging ----------
const logEl = document.getElementById('log');
function log(...args){ const s = args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' '); logEl.textContent += s + "\n"; console.log(...args); }

// ---------- Candidate URL builder ----------
function candidates(base, raw, file){
  const list = [];
  if (base) list.push(`${base.replace(/\/$/,'')}/${file}`);
  list.push(`/${file}`);
  if (raw) list.push(`${raw.replace(/\/$/,'')}/${file}`);
  return list;
}

// ---------- Normalizers ----------
function normSearch(j){ if (Array.isArray(j)) return j; if (j && typeof j==='object') return j.items||j.docs||j.search||j.results||j.index||[]; return []; }
function normReg(j){ if (Array.isArray(j)) return j; if (j && typeof j==='object') return j.registry||j.items||j.docs||[]; return []; }
function normX(j){ if (Array.isArray(j)) return {edges:j}; if (j && typeof j==='object'){ if (Array.isArray(j.edges)) return {edges:j.edges}; if (j.graph && Array.isArray(j.graph.edges)) return {edges:j.graph.edges}; if (Array.isArray(j.links)) return {edges:j.links}; if (Array.isArray(j.relations)) return {edges:j.relations}; } return {edges:[]}; }

// ---------- Fetch with fallbacks ----------
async function fetchOne(url){ const t0=performance.now(); const res = await fetch(url,{cache:'no-store'}); const txt = await res.text(); if(!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0,120)}`); let j; try{ j = JSON.parse(txt); }catch(e){ throw new Error(`Parse error: ${e.message}. First 200: ${txt.slice(0,200)}`); } return { j, ms:(performance.now()-t0).toFixed(1) }; }
async function getJson(name, file, base, raw){
  const urls = candidates(base, raw, file);
  let lastErr = null;
  for(const u of urls){
    try{
      log('Trying', name, '→', u);
      const {j, ms} = await fetchOne(u);
      log('OK', name, '@', u, `${ms}ms`);
      return { url:u, json:j };
    }catch(e){ lastErr = e; log('FAIL', name, '@', u, String(e)); }
  }
  throw new Error(`Could not load ${name}: ${lastErr}`);
}

// ---------- Probe routine ----------
async function probe(){
  const base = baseInput.value.trim();
  const raw  = rawInput.value.trim();
  logEl.textContent='';
  document.getElementById('status').textContent='Probing…';

  let reg, s, x;
  try{
    reg = await getJson('registry.json','registry.json',base,raw);
  }catch(e){}
  try{
    s = await getJson('search.json','search.json',base,raw);
  }catch(e){}
  try{
    x = await getJson('cross_links.json','cross_links.json',base,raw);
  }catch(e){}

  const REG = reg ? normReg(reg.json) : [];
  const SEA = s   ? normSearch(s.json) : [];
  const XL  = x   ? normX(x.json).edges : [];

  // Update UI
  const regBadge = document.getElementById('regStatus');
  const sBadge   = document.getElementById('sStatus');
  const xBadge   = document.getElementById('xStatus');

  function setBadge(el, ok){ el.textContent = ok ? 'OK' : 'ERR'; el.className = 'badge ' + (ok?'ok':'err'); }
  setBadge(regBadge, !!reg);
  setBadge(sBadge, !!s);
  setBadge(xBadge, !!x);

  document.getElementById('regCount').textContent = REG.length + ' items';
  document.getElementById('sCount').textContent   = SEA.length + ' docs';
  document.getElementById('xCount').textContent   = XL.length  + ' edges';

  document.getElementById('regPreview').textContent = reg ? JSON.stringify(REG.slice(0,3),null,2) : '';
  document.getElementById('sPreview').textContent   = s   ? JSON.stringify(SEA.slice(0,3),null,2) : '';
  document.getElementById('xPreview').textContent   = x   ? JSON.stringify(XL.slice(0,3),null,2) : '';

  document.getElementById('resolved').textContent = JSON.stringify({
    registry: reg && reg.url, search: s && s.url, cross_links: x && x.url
  }, null, 2);

  const allOk = !!(reg && s && x);
  document.getElementById('status').innerHTML = allOk ? '<span class="badge ok">Healthy</span>' : '<span class="badge err">Issues detected</span>';

  // Stash globally for download
  window.__KB = { reg, s, x, REG, SEA, XL };
}
document.getElementById('probe').onclick = probe;

// ---------- Auto-probe on load ----------
window.addEventListener('load', ()=>{ probe(); });

// ---------- Preview toggles ----------
document.getElementById('toggleReg').onclick = ()=> document.getElementById('regPreview').classList.toggle('hidden');
document.getElementById('toggleS').onclick   = ()=> document.getElementById('sPreview').classList.toggle('hidden');
document.getElementById('toggleX').onclick   = ()=> document.getElementById('xPreview').classList.toggle('hidden');

// ---------- Download all JSONs as a zip ----------
document.getElementById('downloadAll').onclick = async () => {
  try{
    if(!window.__KB) throw new Error('Nothing loaded yet');
    const zip = new JSZip();
    const {reg, s, x} = window.__KB;
    if(reg) zip.file('registry.json', JSON.stringify(reg.json, null, 2));
    if(s)   zip.file('search.json',   JSON.stringify(s.json,   null, 2));
    if(x)   zip.file('cross_links.json', JSON.stringify(x.json, null, 2));
    const blob = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'kb_payload.zip';
    a.click();
  }catch(e){
    alert('Download failed: ' + e.message);
  }
};
</script>
</body>
</html>
