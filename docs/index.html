
<!doctype html>
<html lang="en">
<head>
<<<<<<< HEAD
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KB Live Viewer + MD → JSON Uploader</title>
  <meta name="description" content="Drop Markdown, ingest losslessly, and generate registry.json, search.json, and cross_links.json (download as ZIP)." />
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <style>
    :root{
      --bg:#0b0b0b;--panel:#121212;--ink:#ececec;--muted:#a9a9a9;--accent:#E1BC56;--cta:#A90F0F;--ok:#1f9d55;--warn:#d39e00;--bad:#c0392b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    header{padding:20px 24px;background:linear-gradient(180deg,#706A6A 0%, #000 100%);border-bottom:1px solid #333}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    main{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns: 1.2fr .8fr}}
    .card{background:var(--panel);border:1px solid #2a2a2a;border-radius:14px;padding:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    input[type="text"],textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:var(--ink)}
    textarea{min-height:96px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;background:#1f1f1f;color:#fff;border:1px solid #333;cursor:pointer}
    .btn.primary{background:var(--cta);border-color:#600;}
    .btn.good{background:var(--ok)}
    .btn.warn{background:var(--warn);color:#222}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #333;background:#0f0f0f;color:#bbb;font-size:12px}
    .drop{border:2px dashed #3a3a3a;border-radius:14px;padding:18px;text-align:center;background:#0e0e0e}
    .drop.drag{border-color:var(--accent);background:#151007}
    .list{max-height:260px;overflow:auto;border:1px solid #222;border-radius:10px}
    .item{padding:10px 12px;border-bottom:1px solid #1a1a1a;display:flex;align-items:center;gap:8px}
    .item:last-child{border-bottom:none}
    .item b{font-weight:600}
    code,kbd{background:#0a0a0a;border:1px solid #333;color:#ddd;padding:2px 6px;border-radius:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ok{color:var(--ok)}.bad{color:var(--bad)}
    .muted{color:var(--muted)}
    footer{opacity:.8;text-align:center;padding:20px}
    .small{font-size:12px}
    details{border:1px dashed #333;border-radius:10px;padding:10px}
    summary{cursor:pointer}
  </style>
=======
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KB Live Viewer + Probe (Integrated)</title>
<meta name="description" content="Load/diagnose KB (registry/search/cross_links), tolerant schemas, base/rawBase switching, and downloads."/>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
<style>
:root{--bg:#0b0b0b;--panel:#121212;--ink:#ececec;--muted:#a9a9a9;--accent:#E1BC56;--cta:#C21C1C;--ok:#1f9d55;--warn:#d39e00;--err:#c0392b;--radius:12px;--border:#1e1e1e;--shadow:0 10px 20px rgba(0,0,0,.25);}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:#000;box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
h1{margin:0;font-size:18px;letter-spacing:.2px}
small.muted{color:var(--muted)}
.container{max-width:1200px;margin:20px auto;padding:0 16px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.btn{background:var(--cta);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.secondary{background:#232323}
.btn.ghost{background:transparent;border:1px solid #333}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.badge.ok{background:rgba(31,157,85,.2);color:var(--ok)}
.badge.err{background:rgba(192,57,43,.2);color:var(--err)}
input,textarea{background:#0f0f0f;color:var(--ink);border:1px solid #2f2f2f;border-radius:10px;padding:9px 10px}
code,pre{background:#0f0f0f;border:1px solid #2f2f2f;border-radius:10px;padding:10px;color:var(--accent)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #272727;text-align:left}
.grid{display:grid;grid-template-columns:repeat(3,minmax(240px,1fr));gap:12px}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:8px}
.hidden{display:none}
footer{opacity:.6;text-align:center;padding:24px}
</style>
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07
</head>
<body>
<<<<<<< HEAD
  <header>
    <h1>KB Live Viewer + Uploader · <span class="muted">MD → registry.json / search.json / cross_links.json</span></h1>
  </header>
  <main>
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill">Status: <span id="status" class="ok">Idle</span></span>
            <span class="pill">Files: <span id="fileCount">0</span></span>
            <span class="pill">Blocks: <span id="blockCount">0</span></span>
          </div>
          <div class="row">
            <button id="btnClear" class="btn" title="Clear files">Clear</button>
          </div>
        </div>
        <div id="drop" class="drop" tabindex="0">
          <p><b>Drop Markdown files here</b> or <label for="file" class="pill" style="cursor:pointer">browse…</label></p>
          <input id="file" type="file" accept=".md,.markdown,.txt" multiple hidden />
          <p class="small muted">Lossless ingestion: headings, code fences, inline links preserved. We auto‑segment into search blocks.</p>
        </div>
        <div class="row" style="margin-top:12px">
          <input id="collection" type="text" placeholder="collection (e.g., kb)" value="kb" />
          <input id="baseUrl" type="text" placeholder="base url for raw links (optional)" value="https://raw.githubusercontent.com/udigitrentals/github-kb/main/docs" />
        </div>
        <details style="margin-top:12px">
          <summary>Advanced: merge with existing JSONs</summary>
          <div class="row" style="margin-top:10px">
            <label>Upload existing <b>registry.json</b> (optional)</label>
            <input id="existingRegistry" type="file" accept="application/json" />
          </div>
          <div class="row">
            <label>Upload existing <b>search.json</b> (optional)</label>
            <input id="existingSearch" type="file" accept="application/json" />
          </div>
          <div class="row">
            <label>Upload existing <b>cross_links.json</b> (optional)</label>
            <input id="existingCross" type="file" accept="application/json" />
          </div>
          <div class="row" style="margin-top:10px">
            <label><input id="dedupe" type="checkbox" checked /> De‑duplicate by <code>id</code> and <code>slug</code></label>
          </div>
        </details>
      </section>
=======
<header>
  <div>
    <h1>KB Live Viewer <small class="muted">+ Integrated Probe</small></h1>
  </div>
  <div class="row">
    <button class="btn secondary" id="theme">Theme</button>
    <button class="btn ghost" id="reload">Reload</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <label>Local base&nbsp;<input id="base" placeholder="/docs" value="/docs"/></label>
      <label>Raw base&nbsp;<input id="rawBase" placeholder="https://raw.githubusercontent.com/ORG/REPO/main/docs"/></label>
      <button class="btn" id="apply">Apply</button>
      <button class="btn ghost" id="clearCache">Clear cache</button>
      <button class="btn ghost" id="probe">Run Probe</button>
      <button class="btn" id="downloadAll">Download all JSONs</button>
    </div>
    <div class="kv">
      <div>Resolved:</div>
      <div id="resolved">—</div>
      <div>Status:</div>
      <div id="status">Waiting…</div>
    </div>
  </div>
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
      <aside class="card">
        <b>Steps</b>
        <ol class="small">
          <li>Drop one or more <b>.md</b> files.</li>
          <li>Click <b>Generate JSONs</b>.</li>
          <li>Download the ZIP and upload <code>registry.json</code>, <code>search.json</code>, <code>cross_links.json</code> to your repo's <code>/docs/</code> folder.</li>
          <li>Redeploy on Vercel.</li>
        </ol>
        <div class="row" style="margin-top:10px">
          <button id="btnGenerate" class="btn primary" disabled>Generate JSONs</button>
          <a id="zipLink" class="btn good" download="kb_payload.zip" href="#" style="display:none">Download ZIP</a>
        </div>
        <p class="small muted" id="genMeta"></p>
        <hr style="border-color:#222" />
        <div class="list" id="fileList"></div>
      </aside>
=======
  <div class="grid">
    <div class="card">
      <h3>registry.json <span id="regStatus" class="badge">—</span></h3>
      <div id="regCount">—</div>
      <pre id="regPreview" class="hidden"></pre>
      <button class="btn ghost" id="toggleReg">Toggle preview</button>
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07
    </div>
<<<<<<< HEAD

    <section class="card" style="margin-top:16px">
      <b>Preview</b>
      <p class="small muted">First 2 generated blocks will appear below for sanity‑check after generation.</p>
      <pre class="mono small" id="preview" style="white-space:pre-wrap"></pre>
    </section>

    <section class="card" style="margin-top:16px">
      <b>Notes</b>
      <ul class="small">
        <li><b>Segmentation</b>: starts a new block on ATX headings (<code>#</code> to <code>###</code>) or horizontal rules (<code>---</code>, <code>***</code>, <code>___</code>), while preserving code fences.</li>
        <li><b>IDs</b>: cryptographic (SHA‑256) over <code>file name + block index + title + content</code>.</li>
        <li><b>registry.json</b>: minimal metadata for each block (id, title, slug, file, block_index, word_count, headings, links, hash).</li>
        <li><b>search.json</b>: searchable items (id, title, excerpt, tokens). You can sharded‑split later if desired.</li>
        <li><b>cross_links.json</b>: graph edges discovered from inline Markdown links.</li>
      </ul>
    </section>

  </main>
  <footer class="small muted">Built for U‑Dig It KB · Client‑side only · No servers required.</footer>

<script>
(function(){
  const $$ = sel => document.querySelector(sel);
  const statusEl = $$('#status');
  const fileList = $$('#fileList');
  const drop = $$('#drop');
  const fileInput = $$('#file');
  const btnGenerate = $$('#btnGenerate');
  const btnClear = $$('#btnClear');
  const zipLink = $$('#zipLink');
  const preview = $$('#preview');
  const fileCountEl = $$('#fileCount');
  const blockCountEl = $$('#blockCount');
  const genMeta = $$('#genMeta');
=======
    <div class="card">
      <h3>search.json <span id="sStatus" class="badge">—</span></h3>
      <div id="sCount">—</div>
      <pre id="sPreview" class="hidden"></pre>
      <button class="btn ghost" id="toggleS">Toggle preview</button>
    </div>
    <div class="card">
      <h3>cross_links.json <span id="xStatus" class="badge">—</span></h3>
      <div id="xCount">—</div>
      <pre id="xPreview" class="hidden"></pre>
      <button class="btn ghost" id="toggleX">Toggle preview</button>
    </div>
  </div>
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  let files = []; // {name, text}

  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = cls || '';
  }

  btnClear.addEventListener('click', () => {
    files = [];
    fileList.innerHTML = '';
    fileCountEl.textContent = '0';
    blockCountEl.textContent = '0';
    btnGenerate.disabled = true;
    zipLink.style.display = 'none';
    preview.textContent = '';
    setStatus('Idle','ok');
  });
=======
  <div class="card">
    <h3>Diagnostic Log</h3>
    <pre id="log" style="max-height:320px;overflow:auto"></pre>
  </div>
</div>
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', e => { drop.classList.remove('drag'); });
  drop.addEventListener('drop', async e => {
    e.preventDefault(); drop.classList.remove('drag');
    await handleFiles(e.dataTransfer.files);
  });
  drop.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async e => { await handleFiles(e.target.files); });
=======
<footer class="container">
  <small>Tip: you can pass <code>?base=/docs&rawBase=https://raw.githubusercontent.com/udigitrentals/github-kb/main/docs</code></small>
</footer>

<script>
// ---------- Theme toggle (light/dark minimal) ----------
document.getElementById('theme').onclick = () => {
  document.body.classList.toggle('light');
};
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  async function handleFiles(list){
    const arr = [...list].filter(f => /\.(md|markdown|txt)$/i.test(f.name));
    for (const f of arr){
      const text = await f.text();
      files.push({name:f.name, text});
      const size = new Intl.NumberFormat().format(f.size);
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<span class="pill">MD</span> <b>${escapeHtml(f.name)}</b> <span class="muted">${size} bytes</span>`;
      fileList.appendChild(el);
    }
    fileCountEl.textContent = String(files.length);
    btnGenerate.disabled = files.length === 0;
    setStatus('Ready','ok');
  }
=======
// ---------- Params & inputs ----------
const qs = new URLSearchParams(location.search);
const baseInput = document.getElementById('base');
const rawInput  = document.getElementById('rawBase');
baseInput.value = qs.get('base') || localStorage.getItem('kb.base') || baseInput.value;
rawInput.value  = qs.get('rawBase') || localStorage.getItem('kb.rawBase') || rawInput.value;
document.getElementById('apply').onclick = () => {
  localStorage.setItem('kb.base', baseInput.value);
  localStorage.setItem('kb.rawBase', rawInput.value);
  location.search = `?base=${encodeURIComponent(baseInput.value)}&rawBase=${encodeURIComponent(rawInput.value)}`;
};
document.getElementById('clearCache').onclick = () => { caches && caches.keys && caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); localStorage.clear(); alert('Cache cleared. Reloading.'); location.reload(); };
document.getElementById('reload').onclick = () => location.reload();
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }
=======
// ---------- Logging ----------
const logEl = document.getElementById('log');
function log(...args){ const s = args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' '); logEl.textContent += s + "\n"; console.log(...args); }
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function slugify(s){
    return s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-').replace(/-+/g,'-').slice(0,120);
  }
=======
// ---------- Candidate URL builder ----------
function candidates(base, raw, file){
  const list = [];
  if (base) list.push(`${base.replace(/\/$/,'')}/${file}`);
  list.push(`/${file}`);
  if (raw) list.push(`${raw.replace(/\/$/,'')}/${file}`);
  return list;
}
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  function tokenize(s){
    return Array.from(new Set((s.toLowerCase().match(/[a-z0-9]{2,}/g) || []).slice(0,1200)));
  }
=======
// ---------- Normalizers ----------
function normSearch(j){ if (Array.isArray(j)) return j; if (j && typeof j==='object') return j.items||j.docs||j.search||j.results||j.index||[]; return []; }
function normReg(j){ if (Array.isArray(j)) return j; if (j && typeof j==='object') return j.registry||j.items||j.docs||[]; return []; }
function normX(j){ if (Array.isArray(j)) return {edges:j}; if (j && typeof j==='object'){ if (Array.isArray(j.edges)) return {edges:j.edges}; if (j.graph && Array.isArray(j.graph.edges)) return {edges:j.graph.edges}; if (Array.isArray(j.links)) return {edges:j.links}; if (Array.isArray(j.relations)) return {edges:j.relations}; } return {edges:[]}; }
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  function extractLinks(md){
    const links = [];
    const re = /\[([^\]]+)\]\(([^)\s]+)(?:\s+\"([^\"]*)\")?\)/g; // [text](url "title")
    let m; while((m = re.exec(md))){ links.push({text:m[1], href:m[2]}); }
    return links;
  }

  function splitBlocks(md){
    // Preserve code fences by temporarily marking them
    const fences = [];
    const fenced = md.replace(/```([\s\S]*?)```/g, (m, p1) => {
      const key = `__FENCE_${fences.length}__`;
      fences.push(m); return key;
    });
    const lines = fenced.split(/\r?\n/);
    const blocks = [];
    let cur = [];
    const hrRe = /^\s*(?:-{3,}|\*{3,}|_{3,})\s*$/;
    const hRe = /^#{1,3}\s+.+/;
    for (let i=0;i<lines.length;i++){
      const L = lines[i];
      if (i>0 && (hRe.test(L) || hrRe.test(L))){
        if (cur.length){ blocks.push(cur.join('\n')); cur = []; }
      }
      cur.push(L);
    }
    if (cur.length) blocks.push(cur.join('\n'));

    // Restore fences
    const restored = blocks.map(b => b.replace(/__FENCE_(\d+)__/g, (_,i)=>fences[+i]));
    return restored.map(b => b.trim()).filter(Boolean);
=======
// ---------- Fetch with fallbacks ----------
async function fetchOne(url){ const t0=performance.now(); const res = await fetch(url,{cache:'no-store'}); const txt = await res.text(); if(!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0,120)}`); let j; try{ j = JSON.parse(txt); }catch(e){ throw new Error(`Parse error: ${e.message}. First 200: ${txt.slice(0,200)}`); } return { j, ms:(performance.now()-t0).toFixed(1) }; }
async function getJson(name, file, base, raw){
  const urls = candidates(base, raw, file);
  let lastErr = null;
  for(const u of urls){
    try{
      log('Trying', name, '→', u);
      const {j, ms} = await fetchOne(u);
      log('OK', name, '@', u, `${ms}ms`);
      return { url:u, json:j };
    }catch(e){ lastErr = e; log('FAIL', name, '@', u, String(e)); }
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07
  }
<<<<<<< HEAD

  function extractTitle(block, fallback){
    const m = block.match(/^#{1,6}\s+(.+)/);
    if (m) return m[1].trim();
    // Try bold line
    const b = block.split(/\n/)[0].trim();
    return b.length>0? (b.length>120? b.slice(0,120)+'…' : b) : fallback;
  }
=======
  throw new Error(`Could not load ${name}: ${lastErr}`);
}
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  function excerpt(s){
    const plain = s.replace(/```[\s\S]*?```/g,' ').replace(/\!\[[^\]]*\]\([^\)]*\)/g,' ').replace(/\[[^\]]*\]\([^\)]*\)/g,' ').replace(/[#>*_`~\-]/g,' ');
    return plain.replace(/\s+/g,' ').trim().slice(0,220);
  }
=======
// ---------- Probe routine ----------
async function probe(){
  const base = baseInput.value.trim();
  const raw  = rawInput.value.trim();
  logEl.textContent='';
  document.getElementById('status').textContent='Probing…';
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
  async function generate(){
    setStatus('Generating…');
    zipLink.style.display = 'none';
    preview.textContent = '';

    const collection = $$('#collection').value.trim() || 'kb';
    const baseUrl = $$('#baseUrl').value.trim();

    // Load existing (optional)
    async function readJson(fileInput){
      const f = fileInput.files && fileInput.files[0];
      if (!f) return null; try{ return JSON.parse(await f.text()); }catch(e){ console.warn('Invalid JSON', e); return null; }
    }
    const existingRegistry = await readJson($$('#existingRegistry'));
    const existingSearch = await readJson($$('#existingSearch'));
    const existingCross = await readJson($$('#existingCross'));
=======
  let reg, s, x;
  try{
    reg = await getJson('registry.json','registry.json',base,raw);
  }catch(e){}
  try{
    s = await getJson('search.json','search.json',base,raw);
  }catch(e){}
  try{
    x = await getJson('cross_links.json','cross_links.json',base,raw);
  }catch(e){}
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    const registryItems = [];
    const searchItems = [];
    const edges = [];
=======
  const REG = reg ? normReg(reg.json) : [];
  const SEA = s   ? normSearch(s.json) : [];
  const XL  = x   ? normX(x.json).edges : [];
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    let totalBlocks = 0;
=======
  // Update UI
  const regBadge = document.getElementById('regStatus');
  const sBadge   = document.getElementById('sStatus');
  const xBadge   = document.getElementById('xStatus');
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    for (const file of files){
      const blocks = splitBlocks(file.text);
      for (let i=0;i<blocks.length;i++){
        const block = blocks[i];
        const title = extractTitle(block, file.name.replace(/\.(md|markdown|txt)$/i,''));
        const id = await sha256Hex(file.name+'|'+i+'|'+title+'|'+block);
        const slug = slugify(title || (file.name+ '-' + i));
        const wc = (block.match(/\S+/g) || []).length;
        const headings = (block.match(/^#{1,6}\s+.+/gm) || []).map(s=>s.replace(/^#+\s+/,'').trim());
        const links = extractLinks(block);
        const now = new Date().toISOString();
        const hash = await sha256Hex(block);
=======
  function setBadge(el, ok){ el.textContent = ok ? 'OK' : 'ERR'; el.className = 'badge ' + (ok?'ok':'err'); }
  setBadge(regBadge, !!reg);
  setBadge(sBadge, !!s);
  setBadge(xBadge, !!x);
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
        registryItems.push({
          id, title, slug, collection, file:file.name, block_index:i, word_count:wc,
          headings, links, hash, updated_at: now,
          raw_url: baseUrl? `${baseUrl}` : null
        });

        searchItems.push({ id, title, excerpt: excerpt(block), tokens: tokenize(block) });

        for (const l of links){
          edges.push({ source:id, target:l.href, label:l.text || null });
        }
      }
      totalBlocks += blocks.length;
    }
=======
  document.getElementById('regCount').textContent = REG.length + ' items';
  document.getElementById('sCount').textContent   = SEA.length + ' docs';
  document.getElementById('xCount').textContent   = XL.length  + ' edges';
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    // Merge with existing (optional)
    const doDedupe = $$('#dedupe').checked;
    function uniqueByIdSlug(arr){
      const seen = new Set();
      const out = [];
      for (const it of arr){
        const k = `${it.id}::${it.slug||''}`;
        if (doDedupe && seen.has(k)) continue;
        seen.add(k); out.push(it);
      }
      return out;
    }
=======
  document.getElementById('regPreview').textContent = reg ? JSON.stringify(REG.slice(0,3),null,2) : '';
  document.getElementById('sPreview').textContent   = s   ? JSON.stringify(SEA.slice(0,3),null,2) : '';
  document.getElementById('xPreview').textContent   = x   ? JSON.stringify(XL.slice(0,3),null,2) : '';

  document.getElementById('resolved').textContent = JSON.stringify({
    registry: reg && reg.url, search: s && s.url, cross_links: x && x.url
  }, null, 2);

  const allOk = !!(reg && s && x);
  document.getElementById('status').innerHTML = allOk ? '<span class="badge ok">Healthy</span>' : '<span class="badge err">Issues detected</span>';

  // Stash globally for download
  window.__KB = { reg, s, x, REG, SEA, XL };
}
document.getElementById('probe').onclick = probe;
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    const registryDoc = {
      version: 1,
      generated_at: new Date().toISOString(),
      items: uniqueByIdSlug([...(existingRegistry?.items||existingRegistry||[]), ...registryItems])
    };
=======
// ---------- Auto-probe on load ----------
window.addEventListener('load', ()=>{ probe(); });
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    const searchDoc = uniqueByIdSlug([...(existingSearch||[]), ...searchItems]);
=======
// ---------- Preview toggles ----------
document.getElementById('toggleReg').onclick = ()=> document.getElementById('regPreview').classList.toggle('hidden');
document.getElementById('toggleS').onclick   = ()=> document.getElementById('sPreview').classList.toggle('hidden');
document.getElementById('toggleX').onclick   = ()=> document.getElementById('xPreview').classList.toggle('hidden');
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

<<<<<<< HEAD
    const crossDoc = {
      version: 1,
      generated_at: new Date().toISOString(),
      edges: uniqueByIdSlug([...(existingCross?.edges||existingCross||[]), ...edges])
    };

    // Preview
    const prev = [registryDoc.items[0], registryDoc.items[1]].filter(Boolean);
    preview.textContent = JSON.stringify(prev, null, 2);

    blockCountEl.textContent = String(totalBlocks);

    // ZIP
    const zip = new JSZip();
    zip.file('registry.json', JSON.stringify(registryDoc, null, 2));
    zip.file('search.json', JSON.stringify(searchDoc, null, 2));
    zip.file('cross_links.json', JSON.stringify(crossDoc, null, 2));

    const blob = await zip.generateAsync({type:'blob'});
    const href = URL.createObjectURL(blob);
    zipLink.href = href; zipLink.style.display = 'inline-block';
    genMeta.textContent = `Created ${registryDoc.items.length} registry items, ${searchDoc.length} search entries, ${crossDoc.edges.length} cross-links.`;
    setStatus('Ready to download','ok');
  }

  btnGenerate.addEventListener('click', generate);
})();
=======
// ---------- Download all JSONs as a zip ----------
document.getElementById('downloadAll').onclick = async () => {
  try{
    if(!window.__KB) throw new Error('Nothing loaded yet');
    const zip = new JSZip();
    const {reg, s, x} = window.__KB;
    if(reg) zip.file('registry.json', JSON.stringify(reg.json, null, 2));
    if(s)   zip.file('search.json',   JSON.stringify(s.json,   null, 2));
    if(x)   zip.file('cross_links.json', JSON.stringify(x.json, null, 2));
    const blob = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'kb_payload.zip';
    a.click();
  }catch(e){
    alert('Download failed: ' + e.message);
  }
};
>>>>>>> 2607c34d96a002de8c46983539a1685469640a07

</script>
</body>
</html>